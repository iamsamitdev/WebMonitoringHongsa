## Website Monitoring Real-time Machine Status - Day 4

### üìã Content
1. [Database Design for RTMS](#database-design)
2. [React API Integration](#api-integration)

### Database Design for RTMS <a name="database-design"></a>
Real Time Machine Status & Forecasting Database Design

<img src="https://d2ydwhgvd3hasw.cloudfront.net/1k79k%2Fpreview%2F73168544%2Fmain_full.jpg?response-content-disposition=inline%3Bfilename%3D%22main_full.jpg%22%3B&response-content-type=image%2Fjpeg&Expires=1764200748&Signature=MnPD8bNLMU4nx4xH77YF0MjOi8I6Y7hLrpwA6ML9zSc2xH57b6~WKkpuBSneA48lTwTLVZiqKPe2jkgfDhYVpebxR8OOeeNoCcqVwjn2gTHfdhe93nuIU-hH2E9umNeW2~ARAUwD8K1Wr8wCJe6~lxxp2h7vIXOF0XaJxGptmGNvJt3RNhUakeRZKjkMx6EZXOc5qFnegA96Ycfc-EvwC6FomsVIUaAL-8Tui0s2bB07ExOU3nWU47hNkA4DJBv86ffOH5tOxenyflK7GubE0652eRwBNAcMU30mUMgc~d571uOaxHZYdprQrIfoEuwWW8lyy3ZwnqybUJoL9Oh66Q__&Key-Pair-Id=APKAJT5WQLLEOADKLHBQ" />

Based on the SQL script, here are the required tables:

1. **AspNetUsers** (Identity & User Management)
   - Standard ASP.NET Core Identity table with custom fields.
   - Columns: `Id`, `UserName`, `Email`, `PasswordHash`, `FirstName`, `LastName`, `EmployeeId`, `DepartmentName`, `EmailConfirmed`, `PhoneNumber`, `TwoFactorEnabled`, `LockoutEnd`, `LockoutEnabled`, `AccessFailedCount`.

2. **MachineStatusConfig**
   - Stores machine status configurations (e.g., Run Continuous, Not Run / Standby).
   - Columns: `StatusID`, `StatusName`, `DefaultLoadMW`.

3. **ForecastRequests** (Header)
   - Stores forecast submission headers.
   - Links to `AspNetUsers` for `SubmittedBy` and `ReviewedBy`.
   - Columns: `RequestID`, `TargetDate`, `RevisionNo`, `RequestStatus`, `SubmittedBy`, `SubmittedDate`, `AdminComment`, `ReviewedBy`, `ReviewedDate`.

4. **ForecastRequestItems** (Detail)
   - Stores detailed forecast items for each request.
   - Columns: `ItemID`, `RequestID`, `StartTime`, `EndTime`, `StatusID`.

5. **DailyMaxLoadStats**
   - Stores daily maximum load statistics.
   - Columns: `StatDate`, `MaxLoadMW`, `RecordedAt`.

6. **ApprovedForecasts** (Final Data)
   - Stores the final approved forecast data used for calculation.
   - Columns: `ForecastID`, `TargetDate`, `StartTime`, `EndTime`, `StatusID`, `CalculatedLoadMW`, `FinalLoadMW`, `IsAdminEdited`, `SourceRequestID`.

7. **ActualMachineLoad** (Real-time Log)
   - Logs real-time actual machine load.
   - Columns: `LogID`, `LogDateTime`, `ActualLoadMW`.

8. **NotificationConfig**
   - Stores configuration for notifications (e.g., threshold percentages).
   - Columns: `ConfigID`, `ConfigKey`, `ConfigValue`, `Description`.

9. **AlertLogs**
   - Logs alerts generated by the system.
   - Columns: `AlertID`, `AlertDateTime`, `AlertType`, `Message`, `ActualMW`, `ForecastMW`, `DiffPercent`, `Recipient`.

#### Step 1: SQL Script to Create Tables

```sql
USE HongsaRtmsDb;
GO
-- 1. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á MachineStatusConfig
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='MachineStatusConfig' AND xtype='U')
BEGIN
    CREATE TABLE MachineStatusConfig (
        StatusID INT PRIMARY KEY, 
        StatusName NVARCHAR(50) NOT NULL,
        DefaultLoadMW DECIMAL(10, 2) NULL 
    );
    -- Insert Master Data
    INSERT INTO MachineStatusConfig (StatusID, StatusName, DefaultLoadMW) VALUES 
    (1, 'Run Continuous', NULL), 
    (0, 'Not Run / Standby', 0.50);
END

-- 2. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ForecastRequests (Header)
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ForecastRequests' AND xtype='U')
BEGIN
    CREATE TABLE ForecastRequests (
        RequestID INT IDENTITY(1,1) PRIMARY KEY,
        TargetDate DATE NOT NULL,
        RevisionNo INT NOT NULL DEFAULT 0,
        RequestStatus NVARCHAR(20) NOT NULL DEFAULT 'Pending' CHECK (RequestStatus IN ('Draft', 'Pending', 'Approved', 'Returned')),
        
        -- *‡∏à‡∏∏‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ NVARCHAR(450) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö AspNetUsers*
        SubmittedBy NVARCHAR(450) NOT NULL, 
        SubmittedDate DATETIME DEFAULT GETDATE(),
        
        AdminComment NVARCHAR(MAX) NULL,
        
        ReviewedBy NVARCHAR(450) NULL,
        ReviewedDate DATETIME NULL,

        -- ‡∏™‡∏£‡πâ‡∏≤‡∏á Relationship ‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á Identity
        CONSTRAINT FK_ForecastRequests_SubmittedBy FOREIGN KEY (SubmittedBy) REFERENCES AspNetUsers(Id),
        CONSTRAINT FK_ForecastRequests_ReviewedBy FOREIGN KEY (ReviewedBy) REFERENCES AspNetUsers(Id)
    );
END

-- 3. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ForecastRequestItems (Detail)
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ForecastRequestItems' AND xtype='U')
BEGIN
    CREATE TABLE ForecastRequestItems (
        ItemID INT IDENTITY(1,1) PRIMARY KEY,
        RequestID INT NOT NULL,
        StartTime TIME(0) NOT NULL,
        EndTime TIME(0) NOT NULL,
        StatusID INT NOT NULL,
        CONSTRAINT FK_ForecastRequestItems_Request FOREIGN KEY (RequestID) REFERENCES ForecastRequests(RequestID) ON DELETE CASCADE,
        CONSTRAINT FK_ForecastRequestItems_Status FOREIGN KEY (StatusID) REFERENCES MachineStatusConfig(StatusID)
    );
END

-- 4. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á DailyMaxLoadStats
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='DailyMaxLoadStats' AND xtype='U')
BEGIN
    CREATE TABLE DailyMaxLoadStats (
        StatDate DATE PRIMARY KEY,
        MaxLoadMW DECIMAL(10, 2) NOT NULL,
        RecordedAt DATETIME DEFAULT GETDATE()
    );
END

-- 5. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ApprovedForecasts (Final Data)
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ApprovedForecasts' AND xtype='U')
BEGIN
    CREATE TABLE ApprovedForecasts (
        ForecastID INT IDENTITY(1,1) PRIMARY KEY,
        TargetDate DATE NOT NULL,
        StartTime TIME(0) NOT NULL,
        EndTime TIME(0) NOT NULL,
        StatusID INT NOT NULL,
        CalculatedLoadMW DECIMAL(10, 2) NOT NULL, -- ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        FinalLoadMW DECIMAL(10, 2) NOT NULL,      -- ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà Admin ‡∏≠‡∏≤‡∏à‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        IsAdminEdited BIT DEFAULT 0,
        SourceRequestID INT,
        CONSTRAINT FK_ApprovedForecasts_Request FOREIGN KEY (SourceRequestID) REFERENCES ForecastRequests(RequestID)
    );
END

-- 6. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ActualMachineLoad (Real-time Log)
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ActualMachineLoad' AND xtype='U')
BEGIN
    CREATE TABLE ActualMachineLoad (
        LogID BIGINT IDENTITY(1,1) PRIMARY KEY,
        LogDateTime DATETIME NOT NULL,
        ActualLoadMW DECIMAL(10, 2) NOT NULL
    );
    CREATE INDEX IX_ActualMachineLoad_LogDateTime ON ActualMachineLoad(LogDateTime);
END

-- 7. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á NotificationConfig
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='NotificationConfig' AND xtype='U')
BEGIN
    CREATE TABLE NotificationConfig (
        ConfigID INT IDENTITY(1,1) PRIMARY KEY,
        ConfigKey NVARCHAR(50) NOT NULL UNIQUE,
        ConfigValue DECIMAL(10, 2) NOT NULL,
        Description NVARCHAR(200)
    );
    INSERT INTO NotificationConfig (ConfigKey, ConfigValue, Description) 
    VALUES ('DiffThresholdPercent', 30.00, 'Alert when Actual differs from Forecast >= 30%');
END

-- 8. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á AlertLogs
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='AlertLogs' AND xtype='U')
BEGIN
    CREATE TABLE AlertLogs (
        AlertID BIGINT IDENTITY(1,1) PRIMARY KEY,
        AlertDateTime DATETIME DEFAULT GETDATE(),
        AlertType NVARCHAR(20),
        Message NVARCHAR(MAX),
        ActualMW DECIMAL(10,2),
        ForecastMW DECIMAL(10,2),
        DiffPercent DECIMAL(5,2),
        Recipient NVARCHAR(MAX)
    );
END
GO
```
#### Step 2: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á AspNetUsers ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏ä‡πà‡∏ô `FirstName`, `LastName`, `EmployeeId`, `DepartmentName`

##### 2.1 ‡∏™‡∏£‡πâ‡∏≤‡∏á Class ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢ IdentityUser
‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ApplicationUser.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á User ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∑‡∏ö‡∏ó‡∏≠‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å IdentityUser

```csharp
using Microsoft.AspNetCore.Identity;

namespace Hongsa.Rtms.Api.Models
{
    // ‡∏™‡∏∑‡∏ö‡∏ó‡∏≠‡∏î‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å IdentityUser (‡πÄ‡∏ä‡πà‡∏ô Id, Username, Email, PasswordHash)
    public class ApplicationUser : IdentityUser
    {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Column ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string EmployeeId { get; set; } = string.Empty;
        public string DepartmentName { get; set; } = string.Empty;
    }
}
```

##### 2.2 ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ApplicationDbContext ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ApplicationUser
‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå Data/ApplicationDbContext.cs ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ Context ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ApplicationUser ‡πÅ‡∏ó‡∏ô IdentityUser ‡∏õ‡∏Å‡∏ï‡∏¥
```csharp
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using Hongsa.Rtms.Api.Models; // ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° using Models

namespace Hongsa.Rtms.Api.Data
{
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å IdentityDbContext ‡πÄ‡∏â‡∏¢‡πÜ ‡πÄ‡∏õ‡πá‡∏ô IdentityDbContext<ApplicationUser>
    public class ApplicationDbContext : IdentityDbContext<ApplicationUser>
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) 
            : base(options)
        {
        }

        // ... DbSet ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ...
    }
}
```

##### 2.3 ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Program.cs
‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Program.cs ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Identity ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ApplicationUser ‡πÅ‡∏ó‡∏ô IdentityUser ‡∏õ‡∏Å‡∏ï‡∏¥
```csharp
using Hongsa.Rtms.Api.Models;
// ... code ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ...

// ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô <IdentityUser, IdentityRole> ‡πÄ‡∏õ‡πá‡∏ô <ApplicationUser, IdentityRole>
builder.Services.AddIdentity<ApplicationUser, IdentityRole>()
    .AddEntityFrameworkStores<ApplicationDbContext>()
    .AddDefaultTokenProviders();

// ... code ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô ...
```

##### 2.4 ‡∏™‡∏±‡πà‡∏á Migration ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
```bash
dotnet ef migrations add AddCustomUserFields
dotnet ef database update
```

#### Step 3: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RegisterModel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏´‡∏°‡πà
‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå RegisterModel.cs ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà

```csharp
using System.ComponentModel.DataAnnotations;

namespace Hongsa.Rtms.Api.Models;

public class RegisterModel
{
    [Required(ErrorMessage = "Username is required")]
    [StringLength(50, ErrorMessage = "Username is too long")]
    [MinLength(3, ErrorMessage = "Username is too short")]
    public required string Username { get; set; }
    
    [Required(ErrorMessage = "Email is required")]
    [EmailAddress(ErrorMessage = "Email is not valid")]
    public required string Email { get; set; }
    
    [Required(ErrorMessage = "Password is required")]
    public required string Password { get; set; }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤
    [Required(ErrorMessage = "First Name is required")]
    public required string FirstName { get; set; }

    [Required(ErrorMessage = "Last Name is required")]
    public required string LastName { get; set; }

    [Required(ErrorMessage = "Employee ID is required")]
    public required string EmployeeId { get; set; }
    
    [Required(ErrorMessage = "Department Name is required")]
    public required string DepartmentName { get; set; }
}
```

#### Step 4: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô Register (API)
‡πÉ‡∏ô Controller ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏ä‡πà‡∏ô AuthenticateController) ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ FirstName, LastName, EmployeeId, DepartmentName ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô ApplicationUser ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å

```csharp
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;

using Hongsa.Rtms.Api.Models;

namespace Hongsa.Rtms.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
public class AuthenticateController: ControllerBase
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly RoleManager<IdentityRole> _roleManager;
    private readonly IConfiguration _configuration;

    // Constructor
    public AuthenticateController(
        UserManager<ApplicationUser> userManager, RoleManager<IdentityRole> roleManager, 
        IConfiguration configuration)
    {
        _userManager = userManager;
        _roleManager = roleManager;
        _configuration = configuration;
    }

    // Register for User
    // Post api/authenticate/register-user
    [HttpPost]
    [Route("register-user")]
    public async Task<ActionResult> RegisterUser([FromBody] RegisterModel model)
    {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ username ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        var userExists = await _userManager.FindByNameAsync(model.Username);
        if (userExists != null)
        {
            return StatusCode(
                StatusCodes.Status500InternalServerError,
                new ResponseModel
                {
                    Status = "Error",
                    Message = "User already exists!"
                }
            );
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ email ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        userExists = await _userManager.FindByEmailAsync(model.Email);
        if (userExists != null)
        {
            return StatusCode(
                StatusCodes.Status500InternalServerError,
                new ResponseModel
                {
                    Status = "Error",
                    Message = "Email already exists!"
                }
            );
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á User
        // ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ApplicationUser ‡πÅ‡∏ó‡∏ô IdentityUser
        ApplicationUser user = new()
        {
            Email = model.Email,
            SecurityStamp = Guid.NewGuid().ToString(),
            UserName = model.Username,
            // Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÑ‡∏õ
            FirstName = model.FirstName,
            LastName = model.LastName,
            EmployeeId = model.EmployeeId,
            DepartmentName = model.DepartmentName
        };

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        var result = await _userManager.CreateAsync(user, model.Password);

        // ‡∏ñ‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        if(!result.Succeeded)
        {
            return StatusCode(
                StatusCodes.Status500InternalServerError,
                new ResponseModel
                {
                    Status = "Error",
                    Message = "User creation failed! Please check user details and try again."
                }
            );
        }

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Roles Admin, User
        if (!await _roleManager.RoleExistsAsync(UserRolesModel.Admin))
        {
            await _roleManager.CreateAsync(new IdentityRole(UserRolesModel.Admin));
        }

        if (await _roleManager.RoleExistsAsync(UserRolesModel.User))
        {
            await _roleManager.CreateAsync(new IdentityRole(UserRolesModel.User));
            await _userManager.AddToRoleAsync(user, UserRolesModel.User);
        }

        return Ok(new ResponseModel
        {
            Status = "Success",
            Message = "User registered successfully"
        });
    }
    
    // Register for Admin
    // Post api/authenticate/register-admin
    [HttpPost]
    [Route("register-admin")]
    public async Task<ActionResult> RegisterAdmin([FromBody] RegisterModel model)
    {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ username ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        var userExists = await _userManager.FindByNameAsync(model.Username);
        if (userExists != null)
        {
            return StatusCode(
                StatusCodes.Status500InternalServerError,
                new ResponseModel
                {
                    Status = "Error",
                    Message = "User already exists!"
                }
            );
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ email ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        userExists = await _userManager.FindByEmailAsync(model.Email);
        if (userExists != null)
        {
            return StatusCode(
                StatusCodes.Status500InternalServerError,
                new ResponseModel
                {
                    Status = "Error",
                    Message = "Email already exists!"
                }
            );
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á User
        // ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ApplicationUser ‡πÅ‡∏ó‡∏ô IdentityUser
        ApplicationUser user = new()
        {
            Email = model.Email,
            SecurityStamp = Guid.NewGuid().ToString(),
            UserName = model.Username,
            // Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÑ‡∏õ
            FirstName = model.FirstName,
            LastName = model.LastName,
            EmployeeId = model.EmployeeId,
            DepartmentName = model.DepartmentName
        };

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        var result = await _userManager.CreateAsync(user, model.Password);

        // ‡∏ñ‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        if(!result.Succeeded)
        {
            return StatusCode(
                StatusCodes.Status500InternalServerError,
                new ResponseModel
                {
                    Status = "Error",
                    Message = "User creation failed! Please check user details and try again."
                }
            );
        }

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Roles Admin, User
        if (await _roleManager.RoleExistsAsync(UserRolesModel.Admin)){
            await _roleManager.CreateAsync(new IdentityRole(UserRolesModel.Admin));
            await _userManager.AddToRoleAsync(user, UserRolesModel.Admin);
        }

        if (!await _roleManager.RoleExistsAsync(UserRolesModel.User)){
            await _roleManager.CreateAsync(new IdentityRole(UserRolesModel.User));
        }

        return Ok(new ResponseModel
        {
            Status = "Success",
            Message = "User registered successfully"
        });
    }

    // Login for User
    // Post api/authenticate/login-user
    [HttpPost("login")]
    public async Task<ActionResult> Login([FromBody] LoginModel model)
    {

        var user = await _userManager.FindByNameAsync(model.Username!);

        // ‡∏ñ‡πâ‡∏≤ login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        if(user != null && await _userManager.CheckPasswordAsync(user, model.Password!))
        {
            var userRoles = await _userManager.GetRolesAsync(user);

            var authClaims = new List<Claim>
            {
                new Claim(ClaimTypes.Name, user.UserName!),
                new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
            };

            foreach (var userRole in userRoles)
            {
                authClaims.Add(new Claim(ClaimTypes.Role, userRole));
            }

            var token = GetToken(authClaims);

            return Ok(new 
            {
                token = new JwtSecurityTokenHandler().WriteToken(token),
                expiration = token.ValidTo
            });
        }

        // ‡∏ñ‡πâ‡∏≤ login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        return Unauthorized();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Token
    private JwtSecurityToken GetToken(List<Claim> authClaims)
    {
        var authSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration["JWT:Secret"]!));

        var timeZoneInfo = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time"); // Windows time zone ID

        // Get the current time in Bangkok time zone
        var currentTime = TimeZoneInfo.ConvertTime(DateTime.UtcNow, timeZoneInfo);

        var token = new JwtSecurityToken(
            issuer: _configuration["JWT:ValidIssuer"],
            audience: _configuration["JWT:ValidAudience"],
            expires: currentTime.AddHours(3),
            claims: authClaims,
            signingCredentials: new SigningCredentials(authSigningKey, SecurityAlgorithms.HmacSha256)
        );

        return token;
    }
}
```

#### Step 5: ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
##### 5.1 ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á MachineStatusConfig
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `MachineStatusConfig.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á MachineStatusConfig ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Hongsa.Rtms.Api.Models;

// 1. Master Data
// for Machine Status Configurations
public class MachineStatusConfig
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.None)]
    public int StatusID { get; set; }
    public string StatusName { get; set; } = string.Empty;
    public decimal? DefaultLoadMW { get; set; }
}
```

##### 5.2 ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á ForecastRequests
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ForecastRequest.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ForecastRequests ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Hongsa.Rtms.Api.Models;

// 2. Transaction Header
// for Forecast Requests
public class ForecastRequest
{
    [Key]
    public int RequestID { get; set; }
    public DateTime TargetDate { get; set; }
    public int RevisionNo { get; set; }
    public string RequestStatus { get; set; } = "Pending"; // Draft, Pending, Approved, Returned

    [ForeignKey("Submitter")]
    public string SubmittedBy { get; set; } = string.Empty;
    public virtual ApplicationUser? Submitter { get; set; } // Link to your Identity User
    public DateTime SubmittedDate { get; set; } = DateTime.Now;

    public string? AdminComment { get; set; }

    [ForeignKey("Reviewer")]
    public string? ReviewedBy { get; set; }
    public virtual ApplicationUser? Reviewer { get; set; }
    public DateTime? ReviewedDate { get; set; }

    public virtual ICollection<ForecastRequestItem> Items { get; set; } = new List<ForecastRequestItem>();
}
```

##### 5.3 ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á ForecastRequestItems
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ForecastRequestItem.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ForecastRequestItems ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Hongsa.Rtms.Api.Models;

// 3. Transaction Detail
// for Forecast Request Items
public class ForecastRequestItem
{
    [Key]
    public int ItemID { get; set; }
    public int RequestID { get; set; }
    public TimeSpan StartTime { get; set; }
    public TimeSpan EndTime { get; set; }
    public int StatusID { get; set; }
    
    [ForeignKey("StatusID")]
    public virtual MachineStatusConfig? StatusConfig { get; set; }
}
```

##### 5.4 ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á ApprovedForecast
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ApprovedForecast.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ApprovedForecast ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Hongsa.Rtms.Api.Models;

// 4. Final Data (Approved)
// for Approved Forecasts
public class ApprovedForecast
{
    [Key]
    public int ForecastID { get; set; }
    public DateTime TargetDate { get; set; }
    public TimeSpan StartTime { get; set; }
    public TimeSpan EndTime { get; set; }
    public int StatusID { get; set; }
    public decimal CalculatedLoadMW { get; set; }
    public decimal FinalLoadMW { get; set; }
    public bool IsAdminEdited { get; set; }
    public int? SourceRequestID { get; set; }
}
```

##### 5.5 ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á DailyMaxLoadStats
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `DailyMaxLoadStats.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á DailyMaxLoadStats ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Hongsa.Rtms.Api.Models;

// 5. Stats & Logs
// for Daily Max Load Statistics
public class DailyMaxLoadStats
{
    [Key]
    public DateTime StatDate { get; set; }
    public decimal MaxLoadMW { get; set; }
    public DateTime RecordedAt { get; set; } = DateTime.Now;
}
```

##### 5.6 ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á ActualMachineLoad
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ActualMachineLoad.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ActualMachineLoad ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Hongsa.Rtms.Api.Models;

// 6. Actual Machine Load Logs
// for Actual Load Data Logging
public class ActualMachineLoad
{
    [Key]
    public long LogID { get; set; }
    public DateTime LogDateTime { get; set; }
    public decimal ActualLoadMW { get; set; }
}
```

##### 5.7 ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á NotificationConfig
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `NotificationConfig.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á NotificationConfig ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Hongsa.Rtms.Api.Models;

// 7. Notification Configurations
// for Alert Thresholds
public class NotificationConfig
{
    [Key]
    public int ConfigID { get; set; }
    public string ConfigKey { get; set; } = string.Empty;
    public decimal ConfigValue { get; set; }
}
```

##### 5.8 ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á AlertLogs
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `AlertLog.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Models`
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á AlertLogs ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Hongsa.Rtms.Api.Models;

// 8. Alert Logs
// for Alert History
public class AlertLog
{
    [Key]
    public long AlertID { get; set; }
    public DateTime AlertDateTime { get; set; } = DateTime.Now;
    public string? AlertType { get; set; }
    public string? Message { get; set; }
    public decimal ActualMW { get; set; }
    public decimal ForecastMW { get; set; }
    public decimal DiffPercent { get; set; }
}
```

#### Step 6: ‡∏™‡∏£‡πâ‡∏≤‡∏á DTOs (Data Transfer Objects)

##### 6.1 ‡∏™‡∏£‡πâ‡∏≤‡∏á DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `DTOs` ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `SubmitPlanDto.cs` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (Forecast Request)

```csharp
namespace Hongsa.Rtms.Api.DTOs;

// DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (Forecast Request)
public class SubmitPlanDto
{
    public DateTime TargetDate { get; set; }
    public List<PlanItemDto> Items { get; set; } = new();
}
```

##### 6.2 ‡∏™‡∏£‡πâ‡∏≤‡∏á DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `PlanItemDto.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `DTOs` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå

```csharp
namespace Hongsa.Rtms.Api.DTOs;

// DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
public class PlanItemDto
{
    public string StartTime { get; set; } = string.Empty; // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "HH:mm"
    public string EndTime { get; set; } = string.Empty;   // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "HH:mm"
    public int StatusID { get; set; }
}
```

##### 6.3 ‡∏™‡∏£‡πâ‡∏≤‡∏á DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `PreviewResultDto.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `DTOs` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß

```csharp
namespace Hongsa.Rtms.Api.DTOs;

// DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
public class PreviewResultDto
{
    public string StartTime { get; set; } = string.Empty; // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "HH:mm"
    public string EndTime { get; set; } = string.Empty;   // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "HH:mm"
    public int StatusID { get; set; }
    public string StatusName { get; set; } = string.Empty;
    public decimal CalculatedMW { get; set; }
    public string SourceLogic { get; set; } = string.Empty;
}
```

##### 6.4 ‡∏™‡∏£‡πâ‡∏≤‡∏á DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Approve
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ApprovePlanDto.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `DTOs` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÇ‡∏î‡∏¢ Admin

```csharp
namespace Hongsa.Rtms.Api.DTOs;

// DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÇ‡∏î‡∏¢ Admin
public class ApprovePlanDto
{
    public int RequestID { get; set; }
    public List<ApprovedItemDto> Items { get; set; } = new();
}
```

##### 6.5 ‡∏™‡∏£‡πâ‡∏≤‡∏á DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ApprovedItemDto.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `DTOs` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥

```csharp
namespace Hongsa.Rtms.Api.DTOs;

// DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
public class ApprovedItemDto
{
    public string StartTime { get; set; } = string.Empty;
    public string EndTime { get; set; } = string.Empty;
    public decimal FinalLoadMW { get; set; }
}
```

##### 6.6 ‡∏™‡∏£‡πâ‡∏≤‡∏á DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Return
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ReturnPlanDto.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `DTOs` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÇ‡∏î‡∏¢ Admin

```csharp
namespace Hongsa.Rtms.Api.DTOs;

// DTO ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÇ‡∏î‡∏¢ Admin
public class ReturnPlanDto
{
    public int RequestID { get; set; }
    public string Comment { get; set; } = string.Empty;
}
```

#### Step 7: ‡πÄ‡∏û‡∏¥‡πà‡∏° DbSet ‡πÉ‡∏ô ApplicationDbContext
‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå Data/ApplicationDbContext.cs ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏° DbSet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
```csharp
using System;
using System.Collections.Generic;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using Hongsa.Rtms.Api.Models;

namespace Hongsa.Rtms.Api.Data;

public partial class ApplicationDbContext : IdentityDbContext<ApplicationUser>
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options)
    {
    }

    public virtual DbSet<Category> Category { get; set; }

    public virtual DbSet<Product> Product { get; set; }

    public DbSet<MachineStatusConfig> MachineStatusConfigs { get; set; }

    public DbSet<ForecastRequest> ForecastRequests { get; set; }

    public DbSet<ForecastRequestItem> ForecastRequestItems { get; set; }

    public DbSet<ApprovedForecast> ApprovedForecasts { get; set; }

    public DbSet<DailyMaxLoadStats> DailyMaxLoadStats { get; set; }

    public DbSet<ActualMachineLoad> ActualMachineLoads { get; set; }

    public DbSet<NotificationConfig> NotificationConfigs { get; set; }
    
    public DbSet<AlertLog> AlertLogs { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        modelBuilder.Entity<Category>(entity =>
        {
            entity.Property(e => e.CategoryName)
                .HasMaxLength(64)
                .IsUnicode(false);
        });

        modelBuilder.Entity<Product>(entity =>
        {
            entity.Property(e => e.CreatedDate).HasColumnType("datetime");
            entity.Property(e => e.ModifiedDate).HasColumnType("datetime");
            entity.Property(e => e.ProductName)
                .HasMaxLength(128)
                .IsUnicode(false);
            entity.Property(e => e.ProductPicture)
                .HasMaxLength(256)
                .IsUnicode(false);
            entity.Property(e => e.UnitPrice).HasColumnType("decimal(18, 2)");
        });

        modelBuilder.Entity<MachineStatusConfig>(entity =>
        {
            entity.ToTable("MachineStatusConfig");
        });

        modelBuilder.Entity<ForecastRequest>(entity =>
        {
            entity.ToTable("ForecastRequests");
        });

        modelBuilder.Entity<ForecastRequestItem>(entity =>
        {
            entity.ToTable("ForecastRequestItems");
            entity.HasOne<ForecastRequest>()
                .WithMany(r => r.Items)
                .HasForeignKey(i => i.RequestID)
                .OnDelete(DeleteBehavior.Cascade);
        });

        modelBuilder.Entity<ApprovedForecast>(entity =>
        {
            entity.ToTable("ApprovedForecasts");
        });

        modelBuilder.Entity<DailyMaxLoadStats>(entity =>
        {
            entity.ToTable("DailyMaxLoadStats");
        });

        modelBuilder.Entity<ActualMachineLoad>(entity =>
        {
            entity.ToTable("ActualMachineLoad");
        });

        modelBuilder.Entity<NotificationConfig>(entity =>
        {
            entity.ToTable("NotificationConfig");
        });

        modelBuilder.Entity<AlertLog>(entity =>
        {
            entity.ToTable("AlertLogs");
        });

        OnModelCreatingPartial(modelBuilder);
    }

    partial void OnModelCreatingPartial(ModelBuilder modelBuilder);
}
```

#### Step 8: ‡∏™‡∏£‡πâ‡∏≤‡∏á ForecastController ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Forecast Requests
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ `ForecastController.cs` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Controllers` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (Forecast Requests)
```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Hongsa.Rtms.Api.Data;
using Hongsa.Rtms.Api.Models;
using Hongsa.Rtms.Api.DTOs;
using System.Security.Claims;

namespace Hongsa.Rtms.Api.Controllers;

[Route("api/[controller]")]
[ApiController]
public class ForecastController : ControllerBase
{
    private readonly ApplicationDbContext _context;

    public ForecastController(ApplicationDbContext context)
    {
        _context = context;
    }

    // 1. GET Config (Master Data)
    [HttpGet("config")]
    public async Task<IActionResult> GetConfig()
    {
        var statusList = await _context.MachineStatusConfigs.ToListAsync();
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á TimeSlots ‡πÅ‡∏ö‡∏ö Static 00:00 - 23:00 (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        return Ok(new { MachineStatus = statusList });
    }

    // 2. POST Submit Plan (User)
    [HttpPost("submit")]
    public async Task<IActionResult> SubmitPlan([FromBody] SubmitPlanDto dto)
    {
        var userId = User.FindFirstValue(ClaimTypes.NameIdentifier); // ‡∏î‡∏∂‡∏á ID ‡∏Ñ‡∏ô login
        // if (userId == null) return Unauthorized();
        
        // ‡∏Å‡∏£‡∏ì‡∏µ Dev/Test: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ User ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÉ‡∏ô DB ‡πÅ‡∏ó‡∏ô
        if (userId == null)
        {
            var firstUser = await _context.Users.FirstOrDefaultAsync();
            if (firstUser != null) userId = firstUser.Id;
            else return Unauthorized("No user found in database. Please register a user first.");
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ Plan ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Revision
        var existingRequest = await _context.ForecastRequests
            .Where(r => r.TargetDate.Date == dto.TargetDate.Date)
            .OrderByDescending(r => r.RevisionNo)
            .FirstOrDefaultAsync();

        int nextRev = (existingRequest == null) ? 0 : existingRequest.RevisionNo + 1;

        var request = new ForecastRequest
        {
            TargetDate = dto.TargetDate,
            RevisionNo = nextRev,
            RequestStatus = "Pending",
            SubmittedBy = userId,
            SubmittedDate = DateTime.Now
        };

        // Map Items
        foreach (var item in dto.Items)
        {
            request.Items.Add(new ForecastRequestItem
            {
                StartTime = TimeSpan.Parse(item.StartTime),
                EndTime = TimeSpan.Parse(item.EndTime),
                StatusID = item.StatusID
            });
        }

        _context.ForecastRequests.Add(request);
        await _context.SaveChangesAsync();

        return Ok(new { Message = "Plan submitted successfully", Revision = nextRev });
    }

    // 3. GET Pending (Admin)
    [HttpGet("pending")]
    public async Task<IActionResult> GetPending()
    {
        var list = await _context.ForecastRequests
            .Include(r => r.Submitter) // Include User Info
            .Where(r => r.RequestStatus == "Pending")
            .OrderByDescending(r => r.SubmittedDate)
            .ToListAsync();
        return Ok(list);
    }

    // 4. GET Preview Logic (Admin)
    [HttpGet("{requestId}/preview")]
    public async Task<IActionResult> GetPreview(int requestId)
    {
        var request = await _context.ForecastRequests
            .Include(r => r.Items)
            .ThenInclude(i => i.StatusConfig)
            .FirstOrDefaultAsync(r => r.RequestID == requestId);

        if (request == null) return NotFound();

        // Logic: ‡∏î‡∏∂‡∏á Max Load ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô (TargetDate - 1)
        var yesterday = request.TargetDate.AddDays(-1);
        var stats = await _context.DailyMaxLoadStats
            .FirstOrDefaultAsync(s => s.StatDate == yesterday);
        
        decimal maxLoadRef = stats?.MaxLoadMW ?? 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 (‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤ default ‡∏≠‡∏∑‡πà‡∏ô)

        var previewList = new List<PreviewResultDto>();

        foreach (var item in request.Items)
        {
            decimal calcMW = 0;
            string logic = "";

            // ‡∏ñ‡πâ‡∏≤ Config ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Default (‡πÄ‡∏ä‡πà‡∏ô Not Run = 0.5) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Config
            if (item.StatusConfig != null && item.StatusConfig.DefaultLoadMW.HasValue)
            {
                calcMW = item.StatusConfig.DefaultLoadMW.Value;
                logic = "Default Config";
            }
            else
            {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Run Continuous ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ MaxLoad ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
                calcMW = maxLoadRef;
                logic = $"Max Load of {yesterday:dd/MM}";
            }

            previewList.Add(new PreviewResultDto
            {
                StartTime = item.StartTime.ToString(@"hh\:mm"),
                EndTime = item.EndTime.ToString(@"hh\:mm"),
                StatusID = item.StatusID,
                StatusName = item.StatusConfig?.StatusName ?? "-",
                CalculatedMW = calcMW,
                SourceLogic = logic
            });
        }

        return Ok(previewList);
    }

    // 5. POST Approve (Admin)
    [HttpPost("approve")]
    public async Task<IActionResult> ApprovePlan([FromBody] ApprovePlanDto dto)
    {
        var adminId = User.FindFirstValue(ClaimTypes.NameIdentifier);
        // if (adminId == null) return Unauthorized("No user found in database.");
        
        // ‡∏Å‡∏£‡∏ì‡∏µ Dev/Test: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ User ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÉ‡∏ô DB ‡πÅ‡∏ó‡∏ô
        if (adminId == null)
        {
            var firstUser = await _context.Users.FirstOrDefaultAsync();
            if (firstUser != null) adminId = firstUser.Id;
            else return Unauthorized("No user found in database.");
        }

        var request = await _context.ForecastRequests.FindAsync(dto.RequestID);
        if (request == null) return NotFound();

        // Update Header
        request.RequestStatus = "Approved";
        request.ReviewedBy = adminId;
        request.ReviewedDate = DateTime.Now;

        // Save to ApprovedForecasts (Final Table)
        // ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
        var oldApproved = _context.ApprovedForecasts.Where(a => a.TargetDate == request.TargetDate);
        _context.ApprovedForecasts.RemoveRange(oldApproved);

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà Admin ‡∏™‡πà‡∏á‡∏°‡∏≤ (Final Value)
        foreach (var item in dto.Items)
        {
            // *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£ join ‡∏Å‡∏±‡∏ö request.Items ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ StatusID ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
            // ‡πÅ‡∏ï‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠
            var originalItem = await _context.ForecastRequestItems
                    .FirstOrDefaultAsync(x => x.RequestID == dto.RequestID && 
                                        x.StartTime == TimeSpan.Parse(item.StartTime));

            _context.ApprovedForecasts.Add(new ApprovedForecast
            {
                TargetDate = request.TargetDate,
                StartTime = TimeSpan.Parse(item.StartTime),
                EndTime = TimeSpan.Parse(item.EndTime),
                StatusID = originalItem?.StatusID ?? 0,
                CalculatedLoadMW = 0, // ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Original Calculated ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ
                FinalLoadMW = item.FinalLoadMW,
                IsAdminEdited = true, // Admin ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Å‡∏î Approve ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏≤ Admin ‡πÅ‡∏•‡πâ‡∏ß
                SourceRequestID = request.RequestID
            });
        }

        await _context.SaveChangesAsync();
        return Ok(new { Message = "Plan Approved" });
    }

    // 6. POST Return (Admin)
    [HttpPost("return")]
    public async Task<IActionResult> ReturnPlan([FromBody] ReturnPlanDto dto)
    {
        var adminId = User.FindFirstValue(ClaimTypes.NameIdentifier);
        // if (adminId == null) return Unauthorized("No user found in database.");

        // ‡∏Å‡∏£‡∏ì‡∏µ Dev/Test: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ User ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÉ‡∏ô DB ‡πÅ‡∏ó‡∏ô
        if (adminId == null)
        {
            var firstUser = await _context.Users.FirstOrDefaultAsync();
            if (firstUser != null) adminId = firstUser.Id;
            else return Unauthorized("No user found in database.");
        }

        var request = await _context.ForecastRequests.FindAsync(dto.RequestID);
        if (request == null) return NotFound();

        request.RequestStatus = "Returned";
        request.AdminComment = dto.Comment;
        request.ReviewedBy = adminId;
        request.ReviewedDate = DateTime.Now;

        await _context.SaveChangesAsync();

        // TODO: Trigger Email Service Here
        // _emailService.SendReturnEmail(request.SubmittedBy, dto.Comment);

        return Ok(new { Message = "Plan Returned" });
    }
}
```